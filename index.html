<!-- Dashboard Explanation -->
<section id="dashboard-explanation" class="section">
    <div class="container">
        <h2 class="section-title">Dashboard Explanation</h2>
        <div class="about-card">
            <h3>Facility ART Reporter Dashboard</h3>
            <p>This dashboard is designed to automate the generation of weekly ART (Antiretroviral Therapy) reports using line list data from healthcare facilities.</p>
            
            <h4>Key Features:</h4>
            <ul style="text-align: left; margin: 20px 0;">
                <li>Automated data processing from line list exports</li>
                <li>Real-time performance indicators for ART programs</li>
                <li>Visualization of patient retention and adherence metrics</li>
                <li>Comparison of facility performance against targets</li>
                <li>Export functionality for standardized reporting</li>
            </ul>
            
            <h4>How It Works:</h4>
            <p>The system takes raw line list data, processes it through automated workflows, and generates comprehensive reports with key performance indicators. This eliminates manual data entry and reduces reporting time by over 80%.</p>
        </div>
    </div>
</section>

<!-- Code Implementation -->
<section id="code-overview" class="section">
    <div class="container">
        <h2 class="section-title">Code Implementation</h2>
        <div class="about-card">
            <h3>Python Implementation</h3>
            <p>The Facility ART Reporter is built using Python with Streamlit for the web interface, featuring automated data processing and visualization.</p>
            
            <div style="text-align: left; background: var(--background-start); padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4>Key Features Implemented:</h4>
                <ul>
                    <li>Data preprocessing and cleaning</li>
                    <li>Interactive filtering system</li>
                    <li>Automated chart generation with Plotly</li>
                    <li>Data quality assessment</li>
                    <li>Export functionality</li>
                </ul>
                
                <h4>Technologies Used:</h4>
                <div class="tech-badges">
                    <span class="tech-badge">Python</span>
                    <span class="tech-badge">Streamlit</span>
                    <span class="tech-badge">Pandas</span>
                    <span class="tech-badge">Plotly</span>
                    <span class="tech-badge">NumPy</span>
                </div>
            </div>
            
            <div style="text-align: left;">
                <h4>Sample Code Snippet - Main Application Structure:</h4>
                <pre class="code-snippet">
<code style="color: var(--primary-color);">import streamlit as st
import pandas as pd
import plotly.express as px

def main():
    st.set_page_config(page_title="Facility ART Reporter")
    st.title("Facility ART Reporter")
    
    # Data upload and processing
    uploaded_file = st.file_uploader("Upload CSV file", type=["csv"])
    if uploaded_file:
        df = pd.read_csv(uploaded_file)
        df = preprocess_data(df)
        
        # Interactive tabs for different analyses
        tab1, tab2, tab3, tab4 = st.tabs(["Overview", "Demographics", "Treatment", "Data Quality"])
        
        with tab1:
            render_overview(df)
        with tab2:
            render_demographics(df)
        with tab3:
            render_treatment(df)
        with tab4:
            render_data_quality(df)

def render_treatment(df):
    """Generate treatment-related visualizations"""
    if "CurrentARTStatus" in df.columns:
        status_counts = df["CurrentARTStatus"].value_counts()
        fig = px.bar(status_counts, title="Current ART Status Distribution")
        st.plotly_chart(fig, use_container_width=True)

if __name__ == "__main__":
    main()</code>
                </pre>
            </div>
        </div>
    </div>
</section>

<!-- Live Demo -->
<section id="facility-art-reporter" class="section">
    <div class="container">
        <h2 class="section-title">Facility ART Reporter</h2>
        <div class="about-card">
            <h3>Automated Weekly Report Generator</h3>
            <p>Upload your ART line list or use our sample data to generate interactive reports and visualizations.</p>
            
            <!-- Data Source Selection -->
            <div style="background: var(--card-background); padding: 25px; border-radius: 12px; margin: 25px 0; border: 1px solid var(--border-color);">
                <h4 style="color: var(--primary-color); margin-bottom: 20px;">Select Data Source</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="text-align: center;">
                        <button id="loadSampleData" 
                                style="padding: 15px 30px; background: linear-gradient(135deg, var(--accent-color), #22c55e); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; width: 100%; transition: all 0.3s ease;">
                            üìä Load Sample Data
                        </button>
                        <p style="color: var(--secondary-color); font-size: 0.9rem; margin-top: 10px;">Uses pre-loaded facility line list</p>
                    </div>
                    <div style="text-align: center;">
                        <input type="file" id="lineListUpload" accept=".csv" 
                               style="display: none;">
                        <button id="uploadCustomBtn" 
                                style="padding: 15px 30px; background: linear-gradient(135deg, #3b82f6, #6366f1); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; width: 100%; transition: all 0.3s ease;">
                            üìÅ Upload Custom CSV
                        </button>
                        <p style="color: var(--secondary-color); font-size: 0.9rem; margin-top: 10px;">Upload your own line list data</p>
                    </div>
                </div>
                <div id="fileNameDisplay" style="display: none; background: var(--background-start); padding: 10px; border-radius: 6px; margin-top: 15px; text-align: center;">
                    <span style="color: var(--primary-color);">üìÑ Selected file: </span>
                    <span id="fileName" style="color: var(--accent-color); font-weight: 600;"></span>
                </div>
                <button id="processData" 
                        style="padding: 15px 40px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.1rem; margin: 20px auto 0; display: block; transition: all 0.3s ease;"
                        disabled>
                    ‚è≥ Processing...
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" style="display: none; text-align: center; margin: 30px 0;">
                <div style="display: inline-block; padding: 20px; background: var(--card-background); border-radius: 12px;">
                    <div style="width: 50px; height: 50px; border: 5px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite;"></div>
                    <p style="color: var(--primary-color); font-weight: 600;">Processing Data...</p>
                    <p style="color: var(--secondary-color); font-size: 0.9rem;">Generating insights and visualizations</p>
                </div>
            </div>

            <!-- Report Output -->
            <div id="reportOutput" style="display: none;">
                <!-- Metrics Dashboard -->
                <div style="background: var(--card-background); padding: 25px; border-radius: 12px; margin: 25px 0; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 25px; text-align: center;">üìà Key Performance Indicators</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: linear-gradient(135deg, var(--background-start), #1e293b); padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #3b82f6;">
                            <h5 style="color: var(--primary-color); margin-bottom: 10px; font-size: 0.9rem;">Total Patients</h5>
                            <p id="totalPatients" style="font-size: 2.5rem; font-weight: bold; color: #3b82f6; margin: 0;">0</p>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--background-start), #1e293b); padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #10b981;">
                            <h5 style="color: var(--primary-color); margin-bottom: 10px; font-size: 0.9rem;">Active Patients</h5>
                            <p id="activePatients" style="font-size: 2.5rem; font-weight: bold; color: #10b981; margin: 0;">0</p>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--background-start), #1e293b); padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #f59e0b;">
                            <h5 style="color: var(--primary-color); margin-bottom: 10px; font-size: 0.9rem;">Average Age</h5>
                            <p id="avgAge" style="font-size: 2.5rem; font-weight: bold; color: #f59e0b; margin: 0;">0</p>
                            <small style="color: var(--secondary-color);">years</small>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--background-start), #1e293b); padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #8b5cf6;">
                            <h5 style="color: var(--primary-color); margin-bottom: 10px; font-size: 0.9rem;">Female Patients</h5>
                            <p id="femalePatients" style="font-size: 2.5rem; font-weight: bold; color: #8b5cf6; margin: 0;">0%</p>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--background-start), #1e293b); padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #ef4444;">
                            <h5 style="color: var(--primary-color); margin-bottom: 10px; font-size: 0.9rem;">Retention Rate</h5>
                            <p id="retentionRate" style="font-size: 2.5rem; font-weight: bold; color: #ef4444; margin: 0;">0%</p>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--background-start), #1e293b); padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #06b6d4;">
                            <h5 style="color: var(--primary-color); margin-bottom: 10px; font-size: 0.9rem;">Avg Months on ART</h5>
                            <p id="avgMonthsART" style="font-size: 2.5rem; font-weight: bold; color: #06b6d4; margin: 0;">0</p>
                        </div>
                    </div>
                </div>

                <!-- Charts Dashboard -->
                <div style="background: var(--card-background); padding: 30px; border-radius: 12px; margin: 25px 0; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 30px; text-align: center;">üìä Interactive Visualizations</h4>
                    
                    <div style="margin-bottom: 30px;">
                        <h5 style="color: var(--primary-color); margin-bottom: 15px;">Current ART Status Distribution</h5>
                        <div id="artStatusChart" style="height: 350px; background: var(--background-start); border-radius: 8px; padding: 15px; margin-bottom: 25px;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
                        <div>
                            <h5 style="color: var(--primary-color); margin-bottom: 15px;">Age Distribution Histogram</h5>
                            <div id="ageDistributionChart" style="height: 300px; background: var(--background-start); border-radius: 8px; padding: 15px;"></div>
                        </div>
                        <div>
                            <h5 style="color: var(--primary-color); margin-bottom: 15px;">Gender Distribution</h5>
                            <div id="genderDistributionChart" style="height: 300px; background: var(--background-start); border-radius: 8px; padding: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h5 style="color: var(--primary-color); margin-bottom: 15px;">Top 10 Regimens</h5>
                        <div id="regimenChart" style="height: 350px; background: var(--background-start); border-radius: 8px; padding: 15px; margin-bottom: 25px;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
                        <div>
                            <h5 style="color: var(--primary-color); margin-bottom: 15px;">Age Group √ó Sex Crosstab</h5>
                            <div id="ageSexChart" style="height: 350px; background: var(--background-start); border-radius: 8px; padding: 15px;"></div>
                        </div>
                        <div>
                            <h5 style="color: var(--primary-color); margin-bottom: 15px;">Months on ART by Regimen</h5>
                            <div id="monthsARTChart" style="height: 350px; background: var(--background-start); border-radius: 8px; padding: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h5 style="color: var(--primary-color); margin-bottom: 15px;">Treatment Duration Analysis</h5>
                        <div id="treatmentDurationChart" style="height: 350px; background: var(--background-start); border-radius: 8px; padding: 15px;"></div>
                    </div>
                </div>

                <!-- Data Summary -->
                <div style="background: var(--card-background); padding: 25px; border-radius: 12px; margin: 25px 0; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">üìã Data Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: var(--background-start); padding: 20px; border-radius: 8px;">
                            <h5 style="color: var(--primary-color); margin-bottom: 15px;">Patient Status Breakdown</h5>
                            <div id="statusBreakdown" style="color: var(--secondary-color); font-size: 0.9rem;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div style="background: var(--background-start); padding: 20px; border-radius: 8px;">
                            <h5 style="color: var(--primary-color); margin-bottom: 15px;">Regimen Distribution</h5>
                            <div id="regimenBreakdown" style="color: var(--secondary-color); font-size: 0.9rem;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="text-align: center; margin-top: 30px;">
                    <button id="exportReport" 
                            style="padding: 12px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 15px; transition: all 0.3s ease;">
                        üì• Export Report
                    </button>
                    <button id="resetDashboard" 
                            style="padding: 12px 30px; background: linear-gradient(135deg, #6b7280, #4b5563); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                        üîÑ Reset Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add Charting Libraries -->
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<!-- JavaScript for Interactive Dashboard -->
<script>
// Sample ART Line List Data
const sampleLineList = `PatientID,Facility,Age,Sex,CurrentARTStatus,ARTStartDate,RegimenLine,MonthsOnART,ViralLoad,LastVisitDate
P001,Central Hospital,35,Female,Active,2022-01-15,First Line,24,Undetectable,2024-01-15
P002,District Clinic,28,Male,Active,2021-08-22,First Line,30,Undetectable,2024-01-22
P003,Community Health,42,Female,Active,2020-03-10,Second Line,46,250,2024-01-10
P004,Central Hospital,50,Male,Lost to Follow-up,2019-11-05,First Line,50,1200,2023-06-05
P005,District Clinic,31,Female,Active,2022-05-18,First Line,20,Undetectable,2024-01-18
P006,Community Health,29,Male,Transferred Out,2021-12-03,First Line,25,Undetectable,2023-12-03
P007,Central Hospital,45,Female,Active,2020-09-14,Second Line,40,150,2024-01-14
P008,District Clinic,38,Male,Active,2021-04-30,First Line,33,Undetectable,2024-01-30
P009,Community Health,52,Female,Active,2019-07-22,First Line,54,Undetectable,2024-01-22
P010,Central Hospital,41,Male,Active,2022-02-11,First Line,23,Undetectable,2024-01-11
P011,District Clinic,33,Female,Active,2021-10-05,First Line,27,Undetectable,2024-01-05
P012,Community Health,47,Male,Active,2020-06-18,Second Line,43,300,2024-01-18
P013,Central Hospital,39,Female,Lost to Follow-up,2021-03-12,First Line,34,800,2023-09-12
P014,District Clinic,44,Male,Active,2020-12-25,First Line,37,Undetectable,2024-01-25
P015,Community Health,36,Female,Active,2022-07-08,First Line,18,Undetectable,2024-01-08
P016,Central Hospital,27,Male,Active,2021-11-19,First Line,26,Undetectable,2024-01-19
P017,District Clinic,53,Female,Active,2019-05-03,First Line,56,Undetectable,2024-01-03
P018,Community Health,48,Male,Transferred Out,2020-02-27,Second Line,47,200,2023-08-27
P019,Central Hospital,32,Female,Active,2022-03-14,First Line,22,Undetectable,2024-01-14
P020,District Clinic,37,Male,Active,2021-06-09,First Line,31,Undetectable,2024-01-09`;

// DOM Elements
const loadSampleBtn = document.getElementById('loadSampleData');
const uploadCustomBtn = document.getElementById('uploadCustomBtn');
const fileInput = document.getElementById('lineListUpload');
const processBtn = document.getElementById('processData');
const fileNameDisplay = document.getElementById('fileNameDisplay');
const fileNameSpan = document.getElementById('fileName');
const loadingIndicator = document.getElementById('loadingIndicator');
const reportOutput = document.getElementById('reportOutput');

// Metrics Elements
const totalPatientsEl = document.getElementById('totalPatients');
const activePatientsEl = document.getElementById('activePatients');
const avgAgeEl = document.getElementById('avgAge');
const femalePatientsEl = document.getElementById('femalePatients');
const retentionRateEl = document.getElementById('retentionRate');
const avgMonthsARTEl = document.getElementById('avgMonthsART');

// Chart Containers
const artStatusChartEl = document.getElementById('artStatusChart');
const ageDistributionChartEl = document.getElementById('ageDistributionChart');
const genderDistributionChartEl = document.getElementById('genderDistributionChart');
const regimenChartEl = document.getElementById('regimenChart');
const ageSexChartEl = document.getElementById('ageSexChart');
const monthsARTChartEl = document.getElementById('monthsARTChart');
const treatmentDurationChartEl = document.getElementById('treatmentDurationChart');

// Summary Elements
const statusBreakdownEl = document.getElementById('statusBreakdown');
const regimenBreakdownEl = document.getElementById('regimenBreakdown');

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    loadSampleBtn.addEventListener('click', loadSampleData);
    uploadCustomBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    processBtn.addEventListener('click', processData);
    document.getElementById('exportReport').addEventListener('click', exportReport);
    document.getElementById('resetDashboard').addEventListener('click', resetDashboard);
});

function loadSampleData() {
    const csvData = Papa.parse(sampleLineList, {
        header: true,
        skipEmptyLines: true
    });
    
    fileNameDisplay.style.display = 'block';
    fileNameSpan.textContent = 'Sample ART Line List (20 patients)';
    fileInput.value = '';
    
    processBtn.textContent = '‚ú® Process Sample Data';
    processBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
    processBtn.disabled = false;
    
    window.currentData = csvData.data;
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        fileNameDisplay.style.display = 'block';
        fileNameSpan.textContent = file.name;
        
        processBtn.textContent = '‚ö° Process Uploaded Data';
        processBtn.style.background = 'linear-gradient(135deg, var(--accent-color), #22c55e)';
        processBtn.disabled = false;
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                window.currentData = results.data;
            }
        });
    }
}

async function processData() {
    if (!window.currentData) {
        alert('Please select a data source first!');
        return;
    }
    
    // Show loading
    processBtn.disabled = true;
    processBtn.textContent = '‚è≥ Processing...';
    loadingIndicator.style.display = 'block';
    reportOutput.style.display = 'none';
    
    // Simulate processing delay
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    const data = window.currentData;
    
    // Calculate metrics
    const totalPatients = data.length;
    const activePatients = data.filter(p => p.CurrentARTStatus === 'Active').length;
    const ages = data.map(p => parseInt(p.Age)).filter(age => !isNaN(age));
    const avgAge = ages.length > 0 ? (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1) : 0;
    const femalePatients = data.filter(p => p.Sex === 'Female').length;
    const femalePercentage = totalPatients > 0 ? ((femalePatients / totalPatients) * 100).toFixed(1) : 0;
    const retentionRate = totalPatients > 0 ? ((activePatients / totalPatients) * 100).toFixed(1) : 0;
    const monthsOnART = data.map(p => parseInt(p.MonthsOnART)).filter(m => !isNaN(m));
    const avgMonthsART = monthsOnART.length > 0 ? (monthsOnART.reduce((a, b) => a + b, 0) / monthsOnART.length).toFixed(1) : 0;
    
    // Update metrics display
    totalPatientsEl.textContent = totalPatients;
    activePatientsEl.textContent = activePatients;
    avgAgeEl.textContent = avgAge;
    femalePatientsEl.textContent = femalePercentage + '%';
    retentionRateEl.textContent = retentionRate + '%';
    avgMonthsARTEl.textContent = avgMonthsART;
    
    // Generate charts
    generateCharts(data);
    
    // Generate summary tables
    generateSummaryTables(data);
    
    // Hide loading, show results
    loadingIndicator.style.display = 'none';
    reportOutput.style.display = 'block';
    processBtn.disabled = false;
    processBtn.textContent = '‚úÖ Data Processed';
}

function generateCharts(data) {
    // 1. ART Status Distribution
    const statusCounts = {};
    data.forEach(p => {
        const status = p.CurrentARTStatus || 'Unknown';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
    });
    
    const statusData = [{
        x: Object.keys(statusCounts),
        y: Object.values(statusCounts),
        type: 'bar',
        marker: {
            color: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
            line: { color: 'var(--background-start)', width: 2 }
        },
        text: Object.values(statusCounts).map(v => v.toString()),
        textposition: 'auto'
    }];
    
    Plotly.newPlot(artStatusChartEl, statusData, {
        title: { text: '', font: { color: 'var(--primary-color)', size: 14 } },
        paper_bgcolor: 'var(--background-start)',
        plot_bgcolor: 'var(--background-start)',
        font: { color: 'var(--secondary-color)' },
        margin: { t: 30, b: 50, l: 50, r: 30 }
    });
    
    // 2. Age Distribution Histogram
    const ages = data.map(p => parseInt(p.Age)).filter(age => !isNaN(age));
    
    const ageData = [{
        x: ages,
        type: 'histogram',
        marker: { color: '#3b82f6' },
        nbinsx: 10
    }];
    
    Plotly.newPlot(ageDistributionChartEl, ageData, {
        title: { text: '', font: { color: 'var(--primary-color)', size: 14 } },
        paper_bgcolor: 'var(--background-start)',
        plot_bgcolor: 'var(--background-start)',
        font: { color: 'var(--secondary-color)' },
        xaxis: { title: 'Age' },
        yaxis: { title: 'Count' }
    });
    
    // 3. Gender Distribution
    const genderCounts = {};
    data.forEach(p => {
        const gender = p.Sex || 'Unknown';
        genderCounts[gender] = (genderCounts[gender] || 0) + 1;
    });
    
    const genderData = [{
        values: Object.values(genderCounts),
        labels: Object.keys(genderCounts),
        type: 'pie',
        marker: { colors: ['#8b5cf6', '#3b82f6', '#a5b4fc'] },
        hole: 0.4,
        textinfo: 'label+percent',
        textposition: 'outside'
    }];
    
    Plotly.newPlot(genderDistributionChartEl, genderData, {
        title: { text: '', font: { color: 'var(--primary-color)', size: 14 } },
        paper_bgcolor: 'var(--background-start)',
        font: { color: 'var(--secondary-color)' },
        showlegend: true,
        legend: { x: 1, y: 0.5 }
    });
    
    // 4. Top 10 Regimens
    const regimenCounts = {};
    data.forEach(p => {
        const regimen = p.RegimenLine || 'Unknown';
        regimenCounts[regimen] = (regimenCounts[regimen] || 0) + 1;
    });
    
    const sortedRegimens = Object.entries(regimenCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    const regimenData = [{
        x: sortedRegimens.map(r => r[1]),
        y: sortedRegimens.map(r => r[0]),
        type: 'bar',
        orientation: 'h',
        marker: {
            color: sortedRegimens.map((_, i) => 
                `hsl(${200 + i * 20}, 70%, 60%)`
            )
        }
    }];
    
    Plotly.newPlot(regimenChartEl, regimenData, {
        title: { text: '', font: { color: 'var(--primary-color)', size: 14 } },
        paper_bgcolor: 'var(--background-start)',
        plot_bgcolor: 'var(--background-start)',
        font: { color: 'var(--secondary-color)' },
        margin: { t: 30, b: 50, l: 150, r: 30 }
    });
    
    // 5. Age Group √ó Sex Crosstab
    const ageGroups = {
        '0-20': { Male: 0, Female: 0 },
        '21-30': { Male: 0, Female: 0 },
        '31-40': { Male: 0, Female: 0 },
        '41-50': { Male: 0, Female: 0 },
        '51+': { Male: 0, Female: 0 }
    };
    
    data.forEach(p => {
        const age = parseInt(p.Age);
        const gender = p.Sex || 'Unknown';
        
        let group = '51+';
        if (age <= 20) group = '0-20';
        else if (age <= 30) group = '21-30';
        else if (age <= 40) group = '31-40';
        else if (age <= 50) group = '41-50';
        
        if (gender === 'Male' || gender === 'Female') {
            ageGroups[group][gender]++;
        }
    });
    
    const ageSexData = [
        {
            x: Object.keys(ageGroups),
            y: Object.values(ageGroups).map(g => g.Male),
            name: 'Male',
            type: 'bar',
            marker: { color: '#3b82f6' }
        },
        {
            x: Object.keys(ageGroups),
            y: Object.values(ageGroups).map(g => g.Female),
            name: 'Female',
            type: 'bar',
            marker: { color: '#8b5cf6' }
        }
    ];
    
    Plotly.newPlot(ageSexChartEl, ageSexData, {
        title: { text: '', font: { color: 'var(--primary-color)', size: 14 } },
        paper_bgcolor: 'var(--background-start)',
        plot_bgcolor: 'var(--background-start)',
        font: { color: 'var(--secondary-color)' },
        barmode: 'group',
        xaxis: { title: 'Age Group' },
        yaxis: { title: 'Number of Patients' }
    });
    
    // 6. Months on ART by Regimen
    const regimenMonths = {};
    data.forEach(p => {
        const regimen = p.RegimenLine || 'Unknown';
        const months = parseInt(p.MonthsOnART);
        
        if (!isNaN(months)) {
            if (!regimenMonths[regimen]) {
                regimenMonths[regimen] = [];
            }
            regimenMonths[regimen].push(months);
        }
    });
    
    const regimenBoxData = Object.entries(regimenMonths)
        .filter(([_, months]) => months.length > 0)
        .map(([regimen, months]) => ({
            y: months,
            name: regimen,
            type: 'box',
            boxpoints: 'all',
            marker: { color: '#10b981' }
        }));
    
    Plotly.newPlot(monthsARTChartEl, regimenBoxData, {
        title: { text: '', font: { color: 'var(--primary-color)', size: 14 } },
        paper_bgcolor: 'var(--background-start)',
        plot_bgcolor: 'var(--background-start)',
        font: { color: 'var(--secondary-color)' },
        yaxis: { title: 'Months on ART' }
    });
    
    // 7. Treatment Duration Analysis
    const treatmentData = [{
        x: data.map(p => p.PatientID).slice(0, 15),
        y: data.map(p => parseInt(p.MonthsOnART) || 0).slice(0, 15),
        type: 'scatter',
        mode: 'lines+markers',
        marker: { size: 10, color: '#f59e0b' },
        line: { color: '#f59e0b', width: 2 }
    }];
    
    Plotly.newPlot(treatmentDurationChartEl, treatmentData, {
        title: { text: 'Treatment Duration by Patient (Sample)', font: { color: 'var(--primary-color)', size: 14 } },
        paper_bgcolor: 'var(--background-start)',
        plot_bgcolor: 'var(--background-start)',
        font: { color: 'var(--secondary-color)' },
        xaxis: { title: 'Patient ID', tickangle: 45 },
        yaxis: { title: 'Months on ART' }
    });
}

function generateSummaryTables(data) {
    // Status breakdown
    const statusSummary = {};
    data.forEach(p => {
        const status = p.CurrentARTStatus || 'Unknown';
        statusSummary[status] = (statusSummary[status] || 0) + 1;
    });
    
    let statusHTML = '';
    Object.entries(statusSummary).forEach(([status, count]) => {
        const percentage = ((count / data.length) * 100).toFixed(1);
        statusHTML += `
            <div style="margin-bottom: 8px; padding: 5px; border-bottom: 1px solid var(--border-color);">
                <span style="color: var(--primary-color);">${status}:</span>
                <span style="float: right; color: var(--accent-color); font-weight: 600;">
                    ${count} (${percentage}%)
                </span>
            </div>
        `;
    });
    statusBreakdownEl.innerHTML = statusHTML;
    
    // Regimen breakdown
    const regimenSummary = {};
    data.forEach(p => {
        const regimen = p.RegimenLine || 'Unknown';
        regimenSummary[regimen] = (regimenSummary[regimen] || 0) + 1;
    });
    
    let regimenHTML = '';
    Object.entries(regimenSummary)
        .sort((a, b) => b[1] - a[1])
        .forEach(([regimen, count]) => {
            const percentage = ((count / data.length) * 100).toFixed(1);
            regimenHTML += `
                <div style="margin-bottom: 8px; padding: 5px; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--primary-color);">${regimen}:</span>
                    <span style="float: right; color: var(--accent-color); font-weight: 600;">
                        ${count} (${percentage}%)
                    </span>
                </div>
            `;
        });
    regimenBreakdownEl.innerHTML = regimenHTML;
}

function exportReport() {
    alert('Report exported successfully! In a full implementation, this would generate a PDF report.');
    
    // Simulate download
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + 
        encodeURIComponent('ART Program Report - Generated ' + new Date().toLocaleDateString()));
    element.setAttribute('download', 'ART-Report-' + new Date().toISOString().split('T')[0] + '.txt');
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function resetDashboard() {
    // Reset all elements
    window.currentData = null;
    fileInput.value = '';
    fileNameDisplay.style.display = 'none';
    reportOutput.style.display = 'none';
    loadingIndicator.style.display = 'none';
    
    // Reset process button
    processBtn.disabled = true;
    processBtn.textContent = '‚è≥ Processing...';
    processBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
    
    // Reset metrics
    totalPatientsEl.textContent = '0';
    activePatientsEl.textContent = '0';
    avgAgeEl.textContent = '0';
    femalePatientsEl.textContent = '0%';
    retentionRateEl.textContent = '0%';
    avgMonthsARTEl.textContent = '0';
    
    // Clear charts
    Plotly.purge(artStatusChartEl);
    Plotly.purge(ageDistributionChartEl);
    Plotly.purge(genderDistributionChartEl);
    Plotly.purge(regimenChartEl);
    Plotly.purge(ageSexChartEl);
    Plotly.purge(monthsARTChartEl);
    Plotly.purge(treatmentDurationChartEl);
    
    // Clear summaries
    statusBreakdownEl.innerHTML = '';
    regimenBreakdownEl.innerHTML = '';
    
    alert('Dashboard has been reset. Ready for new data!');
}

// Add CSS for spinner animation
const style = document.createElement('style');
style.textContent = `
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>

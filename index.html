<!-- Dashboard Explanation -->
<section id="dashboard-explanation" class="section">
    <div class="container">
        <h2 class="section-title">Dashboard Explanation</h2>
        <div class="about-card">
            <h3>Facility ART Reporter Dashboard</h3>
            <p>This dashboard is designed to automate the generation of weekly ART (Antiretroviral Therapy) reports using line list data from healthcare facilities.</p>
            
            <h4>Key Features:</h4>
            <ul style="text-align: left; margin: 20px 0;">
                <li>Automated data processing from line list exports</li>
                <li>Real-time performance indicators for ART programs</li>
                <li>Visualization of patient retention and adherence metrics</li>
                <li>Comparison of facility performance against targets</li>
                <li>Export functionality for standardized reporting</li>
            </ul>
            
            <h4>How It Works:</h4>
            <p>The system takes raw line list data, processes it through automated workflows, and generates comprehensive reports with key performance indicators. This eliminates manual data entry and reduces reporting time by over 80%.</p>
        </div>
    </div>
</section>

<!-- Code Implementation -->
<section id="code-overview" class="section">
    <div class="container">
        <h2 class="section-title">Code Implementation</h2>
        <div class="about-card">
            <h3>Python Implementation</h3>
            <p>The Facility ART Reporter is built using Python with Streamlit for the web interface, featuring automated data processing and visualization.</p>
            
            <div style="text-align: left; background: var(--background-start); padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4>Key Features Implemented:</h4>
                <ul>
                    <li>Data preprocessing and cleaning</li>
                    <li>Interactive filtering system</li>
                    <li>Automated chart generation with Plotly</li>
                    <li>Data quality assessment</li>
                    <li>Export functionality</li>
                </ul>
                
                <h4>Technologies Used:</h4>
                <div class="tech-badges">
                    <span class="tech-badge">Python</span>
                    <span class="tech-badge">Streamlit</span>
                    <span class="tech-badge">Pandas</span>
                    <span class="tech-badge">Plotly</span>
                    <span class="tech-badge">NumPy</span>
                </div>
            </div>
            
            <div style="text-align: left;">
                <h4>Sample Code Snippet - Main Application Structure:</h4>
                <pre class="code-snippet">
<code style="color: var(--primary-color);">import streamlit as st
import pandas as pd
import plotly.express as px

def main():
    st.set_page_config(page_title="Facility ART Reporter")
    st.title("Facility ART Reporter")
    
    # Data upload and processing
    uploaded_file = st.file_uploader("Upload CSV file", type=["csv"])
    if uploaded_file:
        df = pd.read_csv(uploaded_file)
        df = preprocess_data(df)
        
        # Interactive tabs for different analyses
        tab1, tab2, tab3, tab4 = st.tabs(["Overview", "Demographics", "Treatment", "Data Quality"])
        
        with tab1:
            render_overview(df)
        with tab2:
            render_demographics(df)
        with tab3:
            render_treatment(df)
        with tab4:
            render_data_quality(df)

def render_treatment(df):
    """Generate treatment-related visualizations"""
    if "CurrentARTStatus" in df.columns:
        status_counts = df["CurrentARTStatus"].value_counts()
        fig = px.bar(status_counts, title="Current ART Status Distribution")
        st.plotly_chart(fig, use_container_width=True)

if __name__ == "__main__":
    main()</code>
                </pre>
            </div>
        </div>
    </div>
</section>

<!-- Live Demo -->
<section id="facility-art-reporter" class="section">
    <div class="container">
        <h2 class="section-title">Facility ART Reporter</h2>
        <div class="about-card">
            <h3>Automated Weekly Report Generator</h3>
            <p>This tool processes line list data to generate comprehensive ART program reports. Upload your own data or use the sample line list from the repository.</p>
            
            <div style="background: var(--card-background); padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4>Data Source</h4>
                <div style="display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
                    <button id="loadSampleData" style="padding: 12px 25px; background-color: var(--accent-color); color: var(--background-start); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        Load Sample Data from GitHub
                    </button>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 2px; height: 30px; background-color: var(--border-color);"></div>
                        <span style="color: var(--secondary-color);">OR</span>
                        <div style="width: 2px; height: 30px; background-color: var(--border-color);"></div>
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--secondary-color);">Upload Your Own CSV</label>
                        <input type="file" id="lineListUpload" accept=".csv" style="margin: 10px 0; padding: 10px; background: var(--background-start); color: var(--primary-color); border: 1px solid var(--border-color); border-radius: 4px; width: 100%;">
                        <button id="processUploadedData" style="padding: 10px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px;">Process Uploaded Data</button>
                    </div>
                </div>
                
                <div id="loadingIndicator" style="display: none; text-align: center; margin: 20px 0;">
                    <div style="color: var(--accent-color); font-size: 1.1rem; margin-bottom: 10px;">
                        <span style="display: inline-block; animation: spin 1s linear infinite;">âŸ³</span> Processing data...
                    </div>
                    <div style="width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
                        <div id="progressBar" style="height: 100%; width: 0%; background: var(--accent-color); transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            
            <div id="reportOutput" style="display: none; background: var(--card-background); padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4>ðŸ“Š Generated Report & Analytics</h4>
                
                <!-- Summary Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;" id="summaryMetrics">
                    <!-- Metrics will be populated here -->
                </div>
                
                <!-- Chart Container -->
                <div id="chartContainer" style="margin: 30px 0;">
                    <div id="chartsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px;">
                        <!-- Charts will be generated here -->
                    </div>
                </div>
                
                <!-- Data Quality Table -->
                <div id="dataQualitySection" style="display: none; margin-top: 30px;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Data Quality Assessment</h5>
                    <div style="overflow-x: auto;">
                        <table id="dataQualityTable" style="width: 100%; border-collapse: collapse; color: var(--secondary-color);">
                            <thead>
                                <tr style="background: var(--background-start);">
                                    <th style="padding: 12px; text-align: left; border: 1px solid var(--border-color);">Column</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid var(--border-color);">Total Values</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid var(--border-color);">Missing Values</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid var(--border-color);">Missing %</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid var(--border-color);">Data Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data quality rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Export Options -->
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                    <button id="exportPDF" style="padding: 10px 20px; background-color: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        Export as PDF Report
                    </button>
                    <button id="exportCSV" style="padding: 10px 20px; background-color: var(--accent-color); color: var(--background-start); border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        Export Processed CSV
                    </button>
                    <button id="exportCharts" style="padding: 10px 20px; background-color: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        Export Charts as Images
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include Plotly.js for interactive charts -->
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

<!-- JavaScript for Demo Interactivity -->
<script>
// Sample data URL from your GitHub repository
const SAMPLE_DATA_URL = 'https://raw.githubusercontent.com/markonoja/facility-art-reporter/main/line_list.csv';

// State management
let currentData = null;

// Helper function to simulate data processing with progress
function simulateProgress(callback) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const progressBar = document.getElementById('progressBar');
    
    loadingIndicator.style.display = 'block';
    progressBar.style.width = '0%';
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        progressBar.style.width = `${progress}%`;
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                loadingIndicator.style.display = 'none';
                callback();
            }, 300);
        }
    }, 100);
}

// Parse CSV data
function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim() === '') continue;
        
        const values = lines[i].split(',');
        const row = {};
        
        headers.forEach((header, index) => {
            row[header] = values[index] ? values[index].trim() : '';
        });
        
        data.push(row);
    }
    
    return data;
}

// Calculate metrics from data
function calculateMetrics(data) {
    const metrics = {
        totalPatients: data.length,
        activePatients: data.filter(p => p.CurrentARTStatus === 'Active').length,
        femalePatients: data.filter(p => p.Sex === 'Female').length,
        malePatients: data.filter(p => p.Sex === 'Male').length,
        newEnrollments: data.filter(p => p.ARTStartDate && 
            new Date(p.ARTStartDate) > new Date(Date.now() - 30*24*60*60*1000)).length
    };
    
    // Calculate percentages
    metrics.retentionRate = data.length > 0 ? 
        Math.round((metrics.activePatients / data.length) * 100) : 0;
    
    metrics.femalePercentage = data.length > 0 ? 
        Math.round((metrics.femalePatients / data.length) * 100) : 0;
    
    return metrics;
}

// Generate summary metrics cards
function generateSummaryMetrics(metrics) {
    const container = document.getElementById('summaryMetrics');
    container.innerHTML = '';
    
    const metricCards = [
        { title: 'Total Patients', value: metrics.totalPatients, icon: 'ðŸ‘¥', color: '#3b82f6' },
        { title: 'Active Patients', value: metrics.activePatients, icon: 'âœ…', color: '#10b981' },
        { title: 'Retention Rate', value: `${metrics.retentionRate}%`, icon: 'ðŸ“ˆ', color: '#f59e0b' },
        { title: 'Female Patients', value: `${metrics.femalePercentage}%`, icon: 'ðŸ‘©', color: '#ec4899' },
        { title: 'New Enrollments', value: metrics.newEnrollments, icon: 'ðŸ†•', color: '#8b5cf6' }
    ];
    
    metricCards.forEach(metric => {
        const card = document.createElement('div');
        card.style.background = 'var(--background-start)';
        card.style.padding = '20px';
        card.style.borderRadius = '8px';
        card.style.textAlign = 'center';
        card.style.border = `1px solid ${metric.color}40`;
        
        card.innerHTML = `
            <div style="font-size: 2rem; margin-bottom: 10px;">${metric.icon}</div>
            <div style="font-size: 2rem; font-weight: bold; color: ${metric.color};">${metric.value}</div>
            <div style="color: var(--secondary-color); font-size: 0.9rem; margin-top: 5px;">${metric.title}</div>
        `;
        
        container.appendChild(card);
    });
}

// Generate interactive charts
function generateCharts(data) {
    const container = document.getElementById('chartsGrid');
    container.innerHTML = '';
    
    // 1. ART Status Distribution Chart
    if (data.some(p => p.CurrentARTStatus)) {
        const statusCounts = {};
        data.forEach(p => {
            const status = p.CurrentARTStatus || 'Unknown';
            statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
        
        const statusChart = document.createElement('div');
        statusChart.id = 'statusChart';
        statusChart.style.height = '400px';
        
        container.appendChild(statusChart);
        
        const statusData = [{
            values: Object.values(statusCounts),
            labels: Object.keys(statusCounts),
            type: 'pie',
            hole: 0.4,
            marker: {
                colors: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#3b82f6']
            }
        }];
        
        Plotly.newPlot('statusChart', statusData, {
            title: 'Current ART Status Distribution',
            showlegend: true,
            height: 400
        });
    }
    
    // 2. Age Distribution Chart
    if (data.some(p => p.Age)) {
        const ages = data.map(p => parseInt(p.Age)).filter(age => !isNaN(age));
        
        if (ages.length > 0) {
            const ageChart = document.createElement('div');
            ageChart.id = 'ageChart';
            ageChart.style.height = '400px';
            
            container.appendChild(ageChart);
            
            const ageData = [{
                x: ages,
                type: 'histogram',
                marker: {
                    color: '#3b82f6'
                },
                opacity: 0.7
            }];
            
            Plotly.newPlot('ageChart', ageData, {
                title: 'Patient Age Distribution',
                xaxis: { title: 'Age' },
                yaxis: { title: 'Count' },
                height: 400
            });
        }
    }
    
    // 3. Gender Distribution Chart
    if (data.some(p => p.Sex)) {
        const genderCounts = { Male: 0, Female: 0, Other: 0 };
        data.forEach(p => {
            const gender = p.Sex || 'Other';
            if (genderCounts.hasOwnProperty(gender)) {
                genderCounts[gender]++;
            } else {
                genderCounts.Other++;
            }
        });
        
        const genderChart = document.createElement('div');
        genderChart.id = 'genderChart';
        genderChart.style.height = '400px';
        
        container.appendChild(genderChart);
        
        const genderData = [{
            x: Object.keys(genderCounts).filter(k => genderCounts[k] > 0),
            y: Object.keys(genderCounts).filter(k => genderCounts[k] > 0).map(k => genderCounts[k]),
            type: 'bar',
            marker: {
                color: ['#3b82f6', '#ec4899', '#8b5cf6']
            }
        }];
        
        Plotly.newPlot('genderChart', genderData, {
            title: 'Gender Distribution',
            xaxis: { title: 'Gender' },
            yaxis: { title: 'Count' },
            height: 400
        });
    }
    
    // 4. Regimen Line Chart
    if (data.some(p => p.RegimenLine)) {
        const regimenCounts = {};
        data.forEach(p => {
            const regimen = p.RegimenLine || 'Unknown';
            regimenCounts[regimen] = (regimenCounts[regimen] || 0) + 1;
        });
        
        // Get top 5 regimens
        const topRegimens = Object.entries(regimenCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        const regimenChart = document.createElement('div');
        regimenChart.id = 'regimenChart';
        regimenChart.style.height = '400px';
        
        container.appendChild(regimenChart);
        
        const regimenData = [{
            x: topRegimens.map(r => r[0]),
            y: topRegimens.map(r => r[1]),
            type: 'bar',
            marker: {
                color: '#10b981'
            }
        }];
        
        Plotly.newPlot('regimenChart', regimenData, {
            title: 'Top 5 ART Regimens',
            xaxis: { title: 'Regimen Line' },
            yaxis: { title: 'Patient Count' },
            height: 400
        });
    }
    
    // 5. Data Quality Chart
    const dataQualityChart = document.createElement('div');
    dataQualityChart.id = 'dataQualityChart';
    dataQualityChart.style.height = '400px';
    container.appendChild(dataQualityChart);
    
    const columns = Object.keys(data[0] || {});
    const completenessData = columns.map(col => {
        const total = data.length;
        const nonEmpty = data.filter(p => p[col] && p[col].toString().trim() !== '').length;
        return {
            column: col,
            completeness: total > 0 ? (nonEmpty / total) * 100 : 0
        };
    });
    
    const qualityData = [{
        y: completenessData.map(d => d.column),
        x: completenessData.map(d => d.completeness),
        type: 'bar',
        orientation: 'h',
        marker: {
            color: completenessData.map(d => 
                d.completeness > 90 ? '#10b981' : 
                d.completeness > 70 ? '#f59e0b' : '#ef4444'
            )
        }
    }];
    
    Plotly.newPlot('dataQualityChart', qualityData, {
        title: 'Data Completeness by Column (%)',
        xaxis: { range: [0, 100], title: 'Completeness %' },
        height: 400,
        margin: { l: 150 }
    });
}

// Generate data quality table
function generateDataQualityTable(data) {
    const tableBody = document.querySelector('#dataQualityTable tbody');
    tableBody.innerHTML = '';
    
    const columns = Object.keys(data[0] || {});
    
    columns.forEach(col => {
        const total = data.length;
        const nonEmpty = data.filter(p => p[col] && p[col].toString().trim() !== '').length;
        const missing = total - nonEmpty;
        const missingPercentage = total > 0 ? ((missing / total) * 100).toFixed(2) : 0;
        
        const row = document.createElement('tr');
        row.style.border = '1px solid var(--border-color)';
        
        row.innerHTML = `
            <td style="padding: 12px; border: 1px solid var(--border-color);">${col}</td>
            <td style="padding: 12px; border: 1px solid var(--border-color);">${total}</td>
            <td style="padding: 12px; border: 1px solid var(--border-color); color: ${missing > 0 ? '#ef4444' : 'var(--secondary-color)'}">
                ${missing}
            </td>
            <td style="padding: 12px; border: 1px solid var(--border-color); color: ${missingPercentage > 10 ? '#ef4444' : 'var(--secondary-color)'}">
                ${missingPercentage}%
            </td>
            <td style="padding: 12px; border: 1px solid var(--border-color); color: var(--secondary-color);">
                ${typeof data[0][col] === 'number' ? 'Number' : 'Text'}
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    document.getElementById('dataQualitySection').style.display = 'block';
}

// Process data and generate visualizations
function processAndDisplayData(data) {
    currentData = data;
    
    // Calculate metrics
    const metrics = calculateMetrics(data);
    
    // Generate visualizations
    generateSummaryMetrics(metrics);
    generateCharts(data);
    generateDataQualityTable(data);
    
    // Show the report output
    document.getElementById('reportOutput').style.display = 'block';
    
    // Scroll to report
    document.getElementById('reportOutput').scrollIntoView({ behavior: 'smooth' });
}

// Load sample data from GitHub
document.getElementById('loadSampleData').addEventListener('click', function() {
    simulateProgress(() => {
        fetch(SAMPLE_DATA_URL)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch sample data');
                return response.text();
            })
            .then(csvText => {
                const data = parseCSV(csvText);
                processAndDisplayData(data);
            })
            .catch(error => {
                console.error('Error loading sample data:', error);
                alert('Error loading sample data. Please try again or use the upload feature.');
            });
    });
});

// Process uploaded data
document.getElementById('processUploadedData').addEventListener('click', function() {
    const fileInput = document.getElementById('lineListUpload');
    
    if (!fileInput.files.length) {
        alert('Please select a CSV file first');
        return;
    }
    
    simulateProgress(() => {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = parseCSV(e.target.result);
                processAndDisplayData(data);
            } catch (error) {
                console.error('Error parsing CSV:', error);
                alert('Error parsing CSV file. Please ensure it is a valid CSV format.');
            }
        };
        
        reader.onerror = function() {
            alert('Error reading file. Please try again.');
        };
        
        reader.readAsText(file);
    });
});

// Export functionality
document.getElementById('exportPDF').addEventListener('click', function() {
    alert('PDF export would generate a comprehensive report with all charts and metrics. This feature requires server-side processing.');
});

document.getElementById('exportCSV').addEventListener('click', function() {
    if (!currentData) return;
    
    const headers = Object.keys(currentData[0]);
    const csvContent = [
        headers.join(','),
        ...currentData.map(row => headers.map(header => row[header]).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'processed_art_data.csv';
    a.click();
});

document.getElementById('exportCharts').addEventListener('click', function() {
    alert('Chart export would save all visualizations as high-resolution PNG images. This requires Plotly.js export functionality.');
});

// Allow drag and drop
const uploadArea = document.getElementById('lineListUpload');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--accent-color)';
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.borderColor = 'var(--border-color)';
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--border-color)';
    
    if (e.dataTransfer.files.length) {
        uploadArea.files = e.dataTransfer.files;
        document.getElementById('processUploadedData').style.backgroundColor = '#3b82f6';
    }
});

// Add CSS for loading animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
